name: Deploy to Manitu

on:
  push:
    branches: [ master ]
  repository_dispatch:
    types: [sanity-update]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    # 1. Code holen
    - uses: actions/checkout@v4

    # 2. Node.js installieren
    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # 3. Abh√§ngigkeiten installieren
    - name: Install Dependencies
      run: npm ci

    # 4. Seite bauen (HTML erstellen)
    - name: Build Project
      run: npm run build

    # 5. UPLOAD (Manuell mit LFTP)
    # Wir installieren lftp und laden die Dateien EINZELN hoch (--parallel=1)
    # Das verhindert, dass die Manitu-Firewall blockiert.
    - name: Deploy via LFTP
      run: |
        sudo apt-get update
        sudo apt-get install -y lftp
        lftp -c "set ftp:ssl-allow no; open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }}; mirror -R -v --parallel=1 ./dist /web/new.stadtburschen.de/"