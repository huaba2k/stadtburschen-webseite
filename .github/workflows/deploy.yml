name: Build und Deploy der Stadtburschen Webseite

on:
  push:
    branches: [ master ]
  repository_dispatch:
    types: [sanity-update]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    # 1. Node Setup & Cache (Für Geschwindigkeit)
    - name: Setup Node.js with Cache
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # 2. Installation und Build
    - name: Install Dependencies and Build
      run: |
        npm ci
        npm run build

    # 3. Deployment via LFTP (Optimiert & Robust)
    - name: Deploy via LFTP
      # Secrets werden hier als Umgebungsvariablen für diesen Schritt bereitgestellt
      env:
        FTP_USER: ${{ secrets.FTP_USERNAME }}
        FTP_PASS: ${{ secrets.FTP_PASSWORD }}
        FTP_HOST: ${{ secrets.FTP_SERVER }}
      run: |
        # LFTP installieren
        sudo apt-get update
        sudo apt-get install -y lftp

        # Sicherstellen, dass die Umgebungsvariablen hier genutzt werden
        echo "set ftp:ssl-allow no;" > upload_script.txt
        echo "open -u \"$FTP_USER\",\"$FTP_PASS\" $FTP_HOST;" >> upload_script.txt
        
        # WICHTIG: Mirror-Befehl mit --delete und dem korrekten Quellpfad
        # Wir synchronisieren den Inhalt von ./dist/ in den Zielordner /web/stadtburschen.de/
        # --delete entfernt alle Dateien im Ziel, die nicht in ./dist sind.
        echo "mirror -R -v --delete --parallel=1 ./dist/ /web/stadtburschen.de/" >> upload_script.txt
        
        lftp -f upload_script.txt