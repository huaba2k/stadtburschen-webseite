name: Deploy to Manitu

on:
  push:
    branches: [ master ]
  # DAS IST NEU: Erlaubt den Start von au√üen
  repository_dispatch:
    types: [sanity-update]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install Dependencies
      run: npm install
      
    - name: Build Project
      run: npm run build
      
    - name: Deploy via LFTP (Firewall-Safe)
      run: |
        # 1. Wir installieren das Profi-Tool lftp
        sudo apt-get update
        sudo apt-get install -y lftp
        
        # 2. Wir starten den Upload
        # -u: Benutzer & Passwort
        # set ftp:ssl-allow no: Wir nutzen normales FTP (stabiler bei Massen-Uploads)
        # --parallel=1: WICHTIG! Nur 1 Datei gleichzeitig, damit Manitu nicht blockt
        # mirror -R: Spiegle den lokalen Ordner auf den Server
        lftp -c "set ftp:ssl-allow no; open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }}; mirror -R -v --parallel=1 ./dist /web/new.stadtburschen.de/"