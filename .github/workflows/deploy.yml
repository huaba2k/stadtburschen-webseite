name: Deploy to Manitu

on:
  push:
    branches: [ master ]
  repository_dispatch:
    types: [sanity-update]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    # TURBO 1: Caching für Node.js aktivieren
    # Das spart ca. 30-60 Sekunden bei der Installation
    - name: Install Node.js with Cache
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Build Project
      run: npm run build

    # 5. Deploy via LFTP (LÖST DAS WARNING)
    - name: Deploy via LFTP (Final Fix for Linter)
      # Wir entfernen die 'env:' Deklaration aus dem YAML-Schema, das die Warnungen auslöst.
      
      run: |
        # 1. Zuweisung der Secrets direkt in Shell-Variablen für diesen Schritt
        # (Beachte die Verwendung von 'export' im Shell-Skript statt im YAML-ENV-Block)
        
        # Wichtig: Wir nutzen die korrekte YAML-Syntax für die Werte
        FTP_USER="${{ secrets.FTP_USERNAME }}"
        FTP_PASS="${{ secrets.FTP_PASSWORD }}"
        FTP_HOST="${{ secrets.FTP_SERVER }}"

        sudo apt-get update
        sudo apt-get install -y lftp
        
        # 2. LFTP-Skript wird ausgeführt
        echo "set ftp:ssl-allow no;" > upload_script.txt
        echo "open -u \"$FTP_USER\",\"$FTP_PASS\" $FTP_HOST;" >> upload_script.txt
        echo "mirror -R -v --parallel=1 --no-perms ./dist /web/new.stadtburschen.de/;" >> upload_script.txt
        
        lftp -f upload_script.txt