---
import Layout from '../layouts/Layout.astro';
import { PortableText } from '@portabletext/react';
// NEU: Import der React-Galerie
import Gallery from '../components/react/Gallery.tsx';

export async function getStaticPaths() {
  const { sanityClient } = await import('sanity:client');
  
  // DIE NEUE ABFRAGE:
  // Wir holen uns die URL ("url": asset->url) direkt aus der Datenbank.
  const query = `*[_type == "page" && defined(slug.current)] {
    title,
    slug,
    pageBuilder[]{
      ...,
      
      _type == "textSection" => {
        heading,
        content
      },

      _type == "gallery" => {
        headline,
        images[]{
          "url": asset->url, 
          "alt": asset->originalFilename
        }
      },

      _type == "downloads" => {
        title,
        files[]{
          description,
          "url": asset->url,
          "fileName": asset->originalFilename
        }
      },

      _type == "tableSection" => {
        title,
        dataTable
      }
    }
  }`;

  const pages = await sanityClient.fetch(query);

  return pages.map((page: any) => ({
    params: { slug: page.slug.current },
    props: { page },
  }));
}

interface Props {
  page: any;
}

const { page } = Astro.props;
---

<Layout title={page.title}>
  <div class="pt-32 pb-20 max-w-4xl mx-auto px-4 min-h-[60vh]">
    
    <h1 class="text-4xl md:text-6xl font-serif font-bold text-burschen-blau dark:text-burschen-gold mb-12 text-center">
      {page.title}
    </h1>

    <div class="flex flex-col gap-12 md:gap-16">
      {page.pageBuilder && page.pageBuilder.map((block: any) => {
        
        // A. TEXT BLOCK
        if (block._type === 'textSection') {
          return (
            // Ã„NDERUNG 2: 'mb-0' verhindert, dass der Textblock eigenen Abstand hinzufÃ¼gt
            <div class="prose prose-lg dark:prose-invert max-w-none text-gray-800 dark:text-gray-200 mb-0">
              {block.heading && <h2 class="text-2xl font-bold mb-4 text-burschen-blau dark:text-white">{block.heading}</h2>}
              <PortableText value={block.content} />
            </div>
          );
        }

        // B. BILDER GALERIE (React)
        if (block._type === 'gallery') {
          return (
            // Der Wrapper hier braucht keine extra margins mehr, das macht jetzt das 'gap' oben
            <div class="w-full">
              <Gallery 
                client:load 
                images={block.images} 
                headline={block.headline} 
              />
            </div>
          );
        }

        // C. DATEI DOWNLOADS
        if (block._type === 'downloads') {
          return (
            <div class="bg-gray-50 dark:bg-white/5 p-6 rounded-xl border border-gray-200 dark:border-white/10 shadow-sm transition-colors">
              <h3 class="text-xl font-bold mb-6 flex items-center gap-2 text-gray-900 dark:text-white">
                ðŸ“‚ {block.title || "Downloads"}
              </h3>
              
              <ul class="space-y-3">
                {block.files && block.files.map((file: any) => (
                  <li>
                    <a 
                      href={file.url ? `${file.url}?dl=` : '#'} 
                      download 
                      target="_blank"
                      class="flex items-center gap-3 p-3 rounded-lg bg-white dark:bg-black/40 hover:bg-burschen-blau hover:text-white dark:hover:bg-burschen-gold dark:hover:text-black transition-all group border border-gray-100 dark:border-white/5"
                    >
                      <span class="text-2xl group-hover:scale-110 transition-transform">ðŸ“„</span>
                      <div class="flex flex-col">
                        <span class="font-semibold text-sm md:text-base text-gray-900 dark:text-gray-200 group-hover:text-white dark:group-hover:text-black">
                          {file.description || file.fileName || "Download"}
                        </span>
                        <span class="text-xs text-gray-500 dark:text-gray-400 group-hover:text-blue-100 dark:group-hover:text-black/70">
                          Hier klicken zum Herunterladen
                        </span>
                      </div>
                      <svg class="w-5 h-5 ml-auto text-gray-400 dark:text-gray-500 group-hover:text-white dark:group-hover:text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          );
        }

        // D. TABELLE
        if (block._type === 'tableSection') {
          return (
            <div class="w-full">
              {block.title && <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">{block.title}</h3>}
              <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                <table class="w-full text-left text-sm md:text-base">
                  <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {block.dataTable && block.dataTable.rows && block.dataTable.rows.map((row: any, rowIndex: number) => {
                      const isHeader = rowIndex === 0;
                      return (
                        <tr class={isHeader 
                          ? "bg-burschen-blau text-white dark:bg-black dark:text-burschen-gold font-bold" 
                          : "bg-white dark:bg-[#111] text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-white/5 transition-colors"
                        }>
                          {row.cells && row.cells.map((cell: string) => (
                            <td class="p-4 border-r border-white/10 last:border-r-0">
                              {cell}
                            </td>
                          ))}
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          );
        }

        return null;
      })}
    </div>
  </div>
</Layout>