---
import Layout from '../layouts/Layout.astro';
import { PortableText } from '@portabletext/react';
// WICHTIG: Die Galerie wieder importieren!
import Gallery from '../components/react/Gallery.tsx';

export async function getStaticPaths() {
  const { sanityClient } = await import('sanity:client');
  
  const query = `*[_type == "page" && defined(slug.current)] {
    title,
    slug,
    pageBuilder[]{
      ...,
      
      _type == "textSection" => {
        heading,
        content
      },

      _type == "gallery" => {
        headline,
        images[]{
          "url": asset->url, 
          "alt": asset->originalFilename
        }
      },

      _type == "downloads" => {
        title,
        files[]{
          description,
          "url": asset->url,
          "fileName": asset->originalFilename
        }
      },

      _type == "tableSection" => {
        title,
        dataTable
      },

      _type == "teamSection" => {
        headline,
        members[]{
          name,
          role,
          "imageUrl": image.asset->url
        }
      },

      _type == "formSection" => {
        introText
      }
    }
  }`;

  const pages = await sanityClient.fetch(query);

  return pages.map((page: any) => ({
    params: { slug: page.slug.current },
    props: { page },
  }));
}

interface Props {
  page: any;
}

const { page } = Astro.props;
const success = Astro.url.searchParams.get('success') === 'true';
---

<Layout title={page.title}>
  <div class="pt-32 pb-20 max-w-4xl mx-auto px-4 min-h-[60vh]">
    
    <h1 class="text-4xl md:text-6xl font-serif font-bold text-burschen-blau dark:text-burschen-gold mb-12 text-center">
      {page.title}
    </h1>

    {success && (
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-8 text-center animate-pulse" role="alert">
            <strong class="font-bold">Nachricht gesendet!</strong>
            <span class="block sm:inline"> Wir melden uns in KÃ¼rze bei dir.</span>
        </div>
    )}

    <div class="flex flex-col gap-12 md:gap-16">
      {page.pageBuilder && page.pageBuilder.map((block: any) => {
        
        if (block._type === 'textSection') {
          return (
            <div class="prose prose-lg dark:prose-invert max-w-none text-gray-800 dark:text-gray-200 mb-0">
              {block.heading && <h2 class="text-2xl font-bold mb-4 text-burschen-blau dark:text-white">{block.heading}</h2>}
              <PortableText value={block.content} />
            </div>
          );
        }

        // B. BILDER GALERIE (Jetzt wieder interaktiv!)
        if (block._type === 'gallery') {
          return (
            <div class="w-full">
               {/* client:load ist wichtig fÃ¼r die Interaktion */}
               <Gallery 
                 client:load 
                 images={block.images} 
                 headline={block.headline} 
               />
            </div>
          );
        }

        if (block._type === 'downloads') {
          return (
            <div class="bg-gray-50 dark:bg-white/5 p-6 rounded-xl border border-gray-200 dark:border-white/10 shadow-sm transition-colors">
              <h3 class="text-xl font-bold mb-6 flex items-center gap-2 text-gray-900 dark:text-white">
                ðŸ“‚ {block.title || "Downloads"}
              </h3>
              <ul class="space-y-3">
                {block.files && block.files.map((file: any) => (
                  <li>
                    <a href={file.url ? `${file.url}?dl=` : '#'} download target="_blank" class="flex items-center gap-3 p-3 rounded-lg bg-white dark:bg-black/40 hover:bg-burschen-blau hover:text-white dark:hover:bg-burschen-gold dark:hover:text-black transition-all group border border-gray-100 dark:border-white/5">
                      <span class="text-2xl group-hover:scale-110 transition-transform">ðŸ“„</span>
                      <div class="flex flex-col">
                        <span class="font-semibold text-sm md:text-base text-gray-900 dark:text-gray-200 group-hover:text-white dark:group-hover:text-black">{file.description || file.fileName || "Download"}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400 group-hover:text-blue-100 dark:group-hover:text-black/70">Hier klicken zum Herunterladen</span>
                      </div>
                      <svg class="w-5 h-5 ml-auto text-gray-400 dark:text-gray-500 group-hover:text-white dark:group-hover:text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          );
        }

        if (block._type === 'tableSection') {
           return (
            <div class="w-full">
              {block.title && <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">{block.title}</h3>}
              <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                <table class="w-full text-left text-sm md:text-base">
                  <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {block.dataTable && block.dataTable.rows && block.dataTable.rows.map((row: any, rowIndex: number) => {
                      const isHeader = rowIndex === 0;
                      return (
                        <tr class={isHeader ? "bg-burschen-blau text-white dark:bg-black dark:text-burschen-gold font-bold" : "bg-white dark:bg-[#111] text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-white/5 transition-colors"}>
                          {row.cells && row.cells.map((cell: string) => ( <td class="p-4 border-r border-white/10 last:border-r-0">{cell}</td> ))}
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
           );
        }

        if (block._type === 'teamSection') {
          return (
            <div class="w-full">
              {block.headline && <h3 class="text-2xl font-bold mb-8 text-center text-gray-900 dark:text-white">{block.headline}</h3>}
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8">
                {block.members && block.members.map((member: any) => (
                  <div class="flex flex-col items-center text-center group">
                    <div class="w-32 h-32 md:w-40 md:h-40 rounded-full overflow-hidden border-4 border-burschen-blau/20 dark:border-burschen-gold/20 mb-4 shadow-lg group-hover:border-burschen-blau dark:group-hover:border-burschen-gold transition-colors">
                      {member.imageUrl ? (
                        <img src={`${member.imageUrl}?w=400&h=400&fit=crop`} alt={member.name} class="w-full h-full object-cover" />
                      ) : (
                        <div class="w-full h-full bg-gray-200 dark:bg-gray-800 flex items-center justify-center text-4xl">ðŸ‘¤</div>
                      )}
                    </div>
                    <h4 class="text-lg font-bold text-gray-900 dark:text-white">{member.name}</h4>
                    <p class="text-burschen-blau dark:text-burschen-gold font-medium uppercase text-sm tracking-wider">{member.role}</p>
                  </div>
                ))}
              </div>
            </div>
          );
        }

        if (block._type === 'formSection') {
          return (
             <div class="w-full max-w-2xl mx-auto bg-gray-50 dark:bg-white/5 p-8 rounded-2xl border border-gray-200 dark:border-white/10 shadow-lg">
                {block.introText && <p class="mb-6 text-gray-600 dark:text-gray-300">{block.introText}</p>}
                <form action="/send_mail.php" method="POST" class="space-y-6">
                    <input type="text" name="website_check" class="hidden" autocomplete="off" />
                    <div>
                        <label for="name" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Dein Name</label>
                        <input type="text" id="name" name="name" required class="w-full px-4 py-3 rounded-lg bg-white dark:bg-black/50 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:ring-2 focus:ring-burschen-blau dark:focus:ring-burschen-gold outline-none transition-all" />
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Deine E-Mail</label>
                        <input type="email" id="email" name="email" required class="w-full px-4 py-3 rounded-lg bg-white dark:bg-black/50 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:ring-2 focus:ring-burschen-blau dark:focus:ring-burschen-gold outline-none transition-all" />
                    </div>
                    <div>
                        <label for="message" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Nachricht</label>
                        <textarea id="message" name="message" rows="4" required class="w-full px-4 py-3 rounded-lg bg-white dark:bg-black/50 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:ring-2 focus:ring-burschen-blau dark:focus:ring-burschen-gold outline-none transition-all"></textarea>
                    </div>
                    <button type="submit" class="w-full py-4 bg-burschen-blau hover:bg-blue-700 text-white font-bold rounded-lg shadow-md transition-colors dark:bg-burschen-gold dark:text-black dark:hover:bg-yellow-500">Nachricht absenden</button>
                    <p class="text-xs text-center text-gray-500 mt-4">Mit dem Absenden erklÃ¤rst du dich mit der Verarbeitung deiner Daten gemÃ¤ÃŸ der DatenschutzerklÃ¤rung einverstanden.</p>
                </form>
             </div>
          );
        }

        return null;
      })}
    </div>
  </div>
</Layout>